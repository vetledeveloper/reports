App.Wireframe["Utils"]["reportRegisterExportLinks"]=function(export_url,response,data,links){links.push({text:App.lang("Excel"),url:App.extendUrl(export_url,{export_format:"xls"}),download:true});links.push({text:App.lang("CSV"),url:App.extendUrl(export_url,{export_format:"csv"}),download:true})};jQuery.fn.filterCriteria=function(s){var settings=jQuery.extend({pre_select_filter_id:null,options:null,criterions:null,submit_as:"filter",user_filter:null,data:null,can_add_filter:true,on_show_results:null,on_result_links:null,new_filter_url:null,default_criterion_get_name:function(c){return c},default_criterion_get_value:function(f,c){return typeof(f)=="object"&&typeof(f)&&typeof(f[c])!="undefined"?f[c]:null}},s);return this.each(function(){var wrapper=$(this);var wrapper_id=wrapper.attr("id");var form=wrapper.find("form");var form_head=form.find("div.filter_criteria_head");var form_body=form.find("div.filter_criteria_body");var options_wrapper=form_head.find("div.filter_criteria_options");var results_wrapper=wrapper.find("div.filter_results");var show_criterions_form=function(callback){if(form.is("form.expanded")){if(typeof(callback)=="function"){callback.apply(form[0])}}else{form_body.slideDown(function(){form.addClass("expanded");if(typeof(callback)=="function"){callback.apply(form[0])}})}};var hide_criterions_form=function(callback){if(form.is("form.expanded")){form_body.slideUp(function(){form.removeClass("expanded");if(typeof(callback)=="function"){callback.apply(form[0])}})}else{if(typeof(callback)=="function"){callback.apply(form[0])}}};var run_button=form.find("button[type=submit]").click(function(e){e.stopPropagation()});var block_form=function(){App.Wireframe.PageTitle.setPrintUrl("");results_wrapper.empty().append('<img src="'+App.Wireframe.Utils.indicatorUrl()+'">').addClass("loading");form_head.find("select, input, button").prop("disabled",true)};var unblock_form=function(){results_wrapper.empty().removeClass("loading");form_head.find("select, input, button").prop("disabled",false)};var saved_filters_group=false;var get_saved_filters_group=function(){if(saved_filters_group&&saved_filters_group.length){return saved_filters_group}else{saved_filters_group=filter_picker.find("optgroup");if(saved_filters_group.length==0){filter_picker.append('<option value=""></option>');saved_filters_group=$('<optgroup label="'+App.lang("Saved Filters")+'"></optgroup>').appendTo(filter_picker)}return saved_filters_group}};var selected_filter_id=0;var select_filter=function(filter_id,update_select){if(update_select&&filter_picker.val()!=filter_id){filter_picker.val(filter_id)}if(filter_id==0){save_button.text(App.lang("Save"));if(!settings.new_filter_url){save_button.hide()}delete_button.hide()}else{var filter=get_filter(filter_id);if(typeof(filter)=="object"&&filter){if(filter.permissions["can_edit"]){save_button.show().text(App.lang("Save Changes"))}else{save_button.hide()}if(filter.permissions["can_delete"]){delete_button.show()}else{delete_button.hide()}if(typeof(settings.options)=="object"&&settings.options){for(var option in settings.options){options_wrapper.find("li[filter_option="+option+"] input:checkbox")[0].checked=typeof(filter[option])!="undefined"&&filter[option]}}if(typeof(settings.criterions)=="object"&&settings.criterions){App.each(settings.criterions,function(criterion_name,criterion_data){var row=form_body.find("tr.criterion_"+criterion_name);if(row.length){var data_cell=row.find("td.report_select_data").empty();var selected_choice=typeof(filter[criterion_name])!="undefined"&&filter[criterion_name]?filter[criterion_name]:null;if(selected_choice&&typeof(criterion_data.choices[selected_choice])!="undefined"){row.find("td.report_select_select select").val(selected_choice);if(typeof(criterion_data.choices[selected_choice])=="object"&&typeof(criterion_data.choices[selected_choice]["prepare"])=="function"){var get_name=typeof(criterion_data.choices[selected_choice]["get_name"])=="function"?criterion_data.choices[selected_choice]["get_name"]:settings.default_criterion_get_name;var get_value=typeof(criterion_data.choices[selected_choice]["get_value"])?criterion_data.choices[selected_choice]["get_value"]:settings.default_criterion_get_value;criterion_data.choices[selected_choice]["prepare"].apply(data_cell[0],[settings.submit_as,criterion_name,filter,settings.data,get_name,get_value])}}else{var first_option=row.find("td.report_select_select select option:first");if(first_option.length>0){first_option[0].selected=true}}}})}}else{App.Wireframe.Flash.error("Unknown filter")}}};var get_filter=function(filter_id){var selected_filter=false;App.each(settings.filters,function(id,filter){if(filter.id==filter_id){selected_filter=filter;return false}});return selected_filter};var set_filter=function(filter_id,details,is_new){if(!settings.filters){settings.filters=[]}if(is_new){settings.filters.set(details.id,details)}else{var updated=false;App.each(settings.filters,function(i,filter){if(filter.id==filter_id){settings.filters[i]=details;updated=true;return false}});if(!updated){settings.filters.set(details.id,details)}}};var remove_filter=function(filter_id){if(settings.filters){for(var i in settings.filters){if(settings.filters[i]["id"]==filter_id){if(settings.filters[i]["id"]==filter_id){settings.filters.splice(i,1)}}}}filter_picker.find("option[value="+filter_id+"]").remove();var group=get_saved_filters_group();if(group.find("option").length==0){group.prev().remove();group.remove();saved_filters_group=false}};form_head.click(function(){if(form.is("form.expanded")){hide_criterions_form()}else{show_criterions_form()}});var filter_picker=form_head.find("div.filter_criteria_picker select").change(function(e){select_filter(filter_picker.val()==""?0:parseInt(filter_picker.val()),false)}).click(function(e){e.stopPropagation()});if(typeof(settings.filters)=="object"&&settings.filters){App.each(settings.filters,function(index,filter){get_saved_filters_group().append('<option value="'+filter.id+'">'+App.clean(filter.name)+"</option>")})}if(typeof(settings.options)&&settings.options){var options="";var clicks={};App.each(settings.options,function(option_name,option){var option_help_attributes="";var option_checked="";if(typeof(option.onchange)=="function"){clicks[option_name]=option.onchange}if(typeof(option)=="object"){var option_label=option.label;var option_checked=typeof(option.selected)!="undefined"&&option.selected?'checked="checked"':"";if(typeof(option.description)=="string"&&option){var option_help_attributes='title="'+App.clean(option.description)+'" class="help_available"'}}else{var option_label=option}options+='<li filter_option="'+option_name+'"><input type="checkbox" name="'+settings.submit_as+"["+option_name+']" value="1" '+option_checked+' id="'+wrapper_id+"_options_"+option_name+'"> <label for="'+wrapper_id+"_options_"+option_name+'" '+option_help_attributes+">"+App.clean(option_label)+"</label></li>"});options_wrapper.append("<ul>"+options+"</ul>").show();options_wrapper.find("ul li").click(function(e){var option_name=$(this).attr("filter_option");if(typeof(clicks[option_name])=="function"){clicks[option_name].apply($(this).find("input[type=checkbox]")[0],[wrapper])}e.stopPropagation()})}if(typeof(settings.criterions)=="object"&&settings.criterions){var criterions_table=$('<table class="common" cellspacing="0"><tbody></tbody><tfoot><tr><td></td><td colspan="2" class="filter_buttons"><button class="default" type="submit">'+App.lang("Run")+'</button> <button class="filter_save_button" type="button">'+App.lang("Save")+'</button> <button class="filter_delete_button" type="button">'+App.lang("Remove")+"</button> </td></tr><tfoot></table>").appendTo(form_body);var criterions_table_body=criterions_table.find("tbody");var criterions_table_foot=criterions_table.find("tfoot");for(var criterion in settings.criterions){var row=$('<tr class="report_select criterion_'+criterion+'"><td class="report_select_label">'+App.clean(settings.criterions[criterion]["label"])+'</td><td class="report_select_select"></td><td class="report_select_data"></td></tr>').appendTo(criterions_table);if(typeof(settings.criterions[criterion]["choices"])=="object"&&settings.criterions[criterion]["choices"]){var options="";for(var choice in settings.criterions[criterion]["choices"]){if(typeof(settings.criterions[criterion]["choices"][choice])=="object"){var choice_label=settings.criterions[criterion]["choices"][choice]["label"]}else{var choice_label=settings.criterions[criterion]["choices"][choice]}options+='<option value="'+choice+'">'+App.clean(choice_label)+"</option>"}var select=$('<select name="'+settings.submit_as+"["+criterion+']" criterion="'+criterion+'">'+options+"</select>").appendTo(row.find("td.report_select_select"))}}criterions_table_body.find("tr.report_select").each(function(){var row=$(this);row.find("td.report_select_select select").change(function(){var select=$(this);var choice=select.val();var criterion=select.attr("criterion");var select_data_cell=row.find("td.report_select_data").empty();if(typeof(settings.criterions[criterion]["choices"][choice])=="object"&&typeof(settings.criterions[criterion]["choices"][choice]["prepare"])=="function"){var get_name=typeof(settings.criterions[criterion]["choices"][choice]["get_name"])=="function"?settings.criterions[criterion]["choices"][choice]["get_name"]:settings.default_criterion_get_name;var get_value=typeof(settings.criterions[criterion]["choices"][choice]["get_value"])?settings.criterions[criterion]["choices"][choice]["get_value"]:settings.default_criterion_get_value;settings.criterions[criterion]["choices"][choice]["prepare"].apply(select_data_cell[0],[settings.submit_as,criterion,null,settings.data,get_name,get_value])}})});var save_button=criterions_table_foot.find("td.filter_buttons button.filter_save_button").text(App.lang("Save As")).click(function(){var selected_filter_id=filter_picker.val();if(selected_filter_id&&typeof(selected_filter_id)=="string"){selected_filter_id=parseInt(selected_filter_id)}if(selected_filter_id){var filter=get_filter(selected_filter_id);var filter_name=prompt(App.lang("How would you like to name this filter? Leave unchanged to keep the existing name"),filter.name);if(filter_name!==null){filter_name=jQuery.trim(filter_name);if(filter_name){$.ajax({url:filter.urls["edit"],type:"post",data:form.serialize()+"&submitted=submitted&filter[name]="+filter_name,success:function(response){if(typeof(response)=="object"){if(response.name!==filter.name){filter_picker.find("option[value="+filter.id+"]").text(response.name)}set_filter(filter.id,response);App.Wireframe.Flash.success("Selected filter has been updated")}else{App.Wireframe.Flash.error("Failed to save filter. Please try again later")}},error:function(response){App.Wireframe.Flash.error("Failed to save filter. Please try again later")}})}else{App.Wireframe.Flash.error("Filter name is required")}}}else{var filter_name=prompt(App.lang("How would you like to name this filter?",""));if(filter_name!==null){filter_name=jQuery.trim(filter_name);if(filter_name){if(settings.filters){var exists=false;App.each(settings.filters,function(index,filter){if(filter.name==filter_name){exists=true;return false}});if(exists){App.Wireframe.Flash.error('":name" already exists. Please use a different name',{name:filter_name});return false}}$.ajax({url:settings.new_filter_url,type:"post",data:form.serialize()+"&submitted=submitted&filter[name]="+filter_name,success:function(response){if(typeof(response)=="object"){var group=get_saved_filters_group();var option=$('<option value="'+response.id+'">').text(response.name);var option_added=false;group.find("option").each(function(){var current_option=$(this);if(response.name<current_option.text()){current_option.before(option);option_added=true;return false}});if(!option_added){group.append(option)}set_filter(response.id,response,true);select_filter(response.id,true);App.Wireframe.Flash.success("Filter has been saved")}else{App.Wireframe.Flash.error("Failed to save filter. Please try again later")}},error:function(response){App.Wireframe.Flash.error("Failed to save filter. Please try again later")}})}else{App.Wireframe.Flash.error("Filter name is required")}}}});var delete_button=criterions_table_foot.find("td.filter_buttons button.filter_delete_button").text(App.lang("Remove")).click(function(){var selected_filter_id=filter_picker.val();if(selected_filter_id&&confirm(App.lang("Are you sure that you want to remove selected filter?"))){selected_filter_id=parseInt(selected_filter_id);var filter=get_filter(selected_filter_id);if(typeof(filter)=="object"){if(filter.permissions["can_delete"]){$.ajax({url:filter.urls["delete"],type:"post",data:{submitted:"submitted"},success:function(response){remove_filter(response.id);select_filter(0);App.Wireframe.Flash.success("Selected filter has been removed")},error:function(response){App.Wireframe.Flash.error("Failed to remove selected filter. Please try again later")}})}else{App.Wireframe.Flash.error(App.lang("You don't have permissions to delete this filter"))}}else{App.Wireframe.Flash.error(App.lang("Unknown filter"))}}}).hide();form.submit(function(e){hide_criterions_form(function(){var form_data=form.serialize();block_form();var url=form.attr("action");url+=url.indexOf("?")===-1?"?"+form_data:"&"+form_data;$.ajax({type:"get",url:url,success:function(response){unblock_form();if(typeof(response)=="object"&&response&&response.length>0){App.Wireframe.PageTitle.setPrintUrl(App.extendUrl(form.attr("action"),{"filter[name]":filter_picker.find("option:selected").text(),print:1})+"&"+form_data);if(typeof(settings.on_show_results)=="function"){settings.on_show_results.apply(results_wrapper[0],[response,settings.data,form.serializeArray()]);if(typeof(settings.on_result_links)=="function"){var result_links_wrapper=$('<div class="filter_result_links"></div>').appendTo(results_wrapper);var links=[];settings.on_result_links.apply(result_links_wrapper[0],[response,settings.data,links]);if(links.length){var list=$("<ul></ul>").appendTo(result_links_wrapper);$.each(links,function(k,link){var list_item=$('<li><a href="'+App.clean(link.url)+"&"+form_data+'">'+App.clean(link.text)+"</a></li>").appendTo(list);if(typeof(link.download)!="undefined"&&link.download){list_item.find("a").attr("target","_blank")}if(typeof(link.init)=="function"){link.init.apply(list_item.find("a")[0])}})}else{result_links_wrapper.remove()}}}else{results_wrapper.append('<p class="empty_page">'+App.lang("Filter returned results, but system is not able to display them")+"</p>")}}else{results_wrapper.append('<p class="empty_page">'+App.lang("Filter returned an empty result")+"</p>")}},error:function(){unblock_form();App.Wireframe.Flash.error("Failed to execute filter. Please try again later")}})});return false});if(!settings.can_add_filter){save_button.hide()}}if(settings.pre_select_filter_id){select_filter(settings.pre_select_filter_id,true);form.submit()}})};